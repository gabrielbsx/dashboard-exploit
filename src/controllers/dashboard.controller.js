const axios = require('axios');
const fs = require('fs');
const path = require('path');
const cheerio = require('cheerio');

exports.addProductMagalu = async (req, res, next) => {
    try {
        const { url, amount, interest, from, to } = req.body;

        if (typeof url !== 'undefined' && typeof amount !== 'undefined' && typeof interest !== 'undefined' && typeof from !== 'undefined' && typeof to !== 'undefined') {

            const productmagalu = await axios.get(url, {
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36',
                },
            });
    
            if (productmagalu) {
                var page =  productmagalu.data;
                const $ = cheerio.load(page);
                
                $('.price-template__from').text(`de R$ ${from},00`);
                $('.price-template__text').text(`${to},00`);
                
                var interestClass = $('.price-template').html();
                var last = interestClass.split('</div>');
                
                $('.price-template').html(interestClass.replace(last[last.length - 1], ` em ${amount}x de R$ ${interest},00 sem juros`));


                fs.writeFileSync(__dirname + '/../teste.html', $.html());
            }
        }

        
        return res.render('layouts/main', {
            page: 'addproductmagalu',
        });
    } catch (err) {
        console.log(err);
        return res.render('errors/500');
    }
};